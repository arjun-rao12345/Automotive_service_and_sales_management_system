<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoices - Automotive Service & Sales Management System</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="index.html" class="navbar-brand">
                ðŸš— AutoTrade
            </a>
            <ul class="navbar-menu">
                <li><a href="index.html" class="active">Home</a></li>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="customers.html">Customers</a></li>
                <li><a href="vehicles.html">Vehicles</a></li>
                <li><a href="services.html">Services</a></li>
                <li><a href="history.html">History</a></li>
                <li><a href="employees.html">Employees</a></li>
                <li><a href="inventory.html">Inventory</a></li>
                <li><a href="invoices.html">Invoices</a></li>
                <li><a href="feedback.html">Feedback</a></li>
                <li><a href="insurance.html">Insurance</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <div class="page-header">
            <h1>Invoice Management</h1>
            <p>Manage invoices and track payments</p>
        </div>

        <!-- Filters and Actions -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Invoices</h2>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <select id="payment-filter" class="form-input" style="width: auto;">
                        <option value="">All Invoices</option>
                        <option value="true">Payment Pending</option>
                        <option value="false">Paid</option>
                    </select>
                    <button id="add-invoice-btn" class="btn btn-primary">Create Invoice</button>
                </div>
            </div>

            <!-- Invoices Table -->
            <div id="invoices-table-container">
                <!-- Table will be loaded here -->
            </div>

            <!-- Pagination -->
            <div id="pagination-container" class="pagination">
                <!-- Pagination will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Add/Edit Invoice Modal -->
    <div id="invoice-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="invoice-modal-title" class="modal-title">Create Invoice</h2>
                <span class="close">&times;</span>
            </div>
            <form id="invoice-form">
                <input type="hidden" id="invoice-id" name="invoice_id">

                <div class="form-row">
                    <div class="form-group">
                        <label for="service-request-select" class="form-label">Service Request *</label>
                        <select id="service-request-select" name="service_request_id" class="form-input" required>
                            <option value="">Select Service Request</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="total-amount" class="form-label">Total Amount *</label>
                        <input type="number" id="total-amount" name="total_amount" class="form-input" step="0.01" min="0" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="invoice-date" class="form-label">Invoice Date *</label>
                        <input type="date" id="invoice-date" name="date" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="due-date" class="form-label">Due Date</label>
                        <input type="date" id="due-date" name="due_date" class="form-input">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="payment-pending" class="form-label">Payment Status</label>
                        <select id="payment-pending" name="payment_pending" class="form-input">
                            <option value="true">Payment Pending</option>
                            <option value="false">Paid</option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary">Save Invoice</button>
                    <button type="button" id="invoice-cancel-btn" class="btn btn-secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Invoice Details Modal -->
    <div id="invoice-details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Invoice Details</h2>
                <span class="close">&times;</span>
            </div>
            <div id="invoice-details-content" style="padding: 1.5rem;">
                <!-- Details will be loaded here -->
            </div>
            <div style="padding: 1.5rem; padding-top: 0;">
                <button id="add-payment-btn" class="btn btn-primary">Add Payment</button>
                <button id="edit-invoice-btn" class="btn btn-secondary">Edit Invoice</button>
            </div>
        </div>
    </div>

    <!-- Add Payment Modal -->
    <div id="payment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Payment</h2>
                <span class="close">&times;</span>
            </div>
            <form id="payment-form">
                <input type="hidden" id="payment-invoice-id" name="invoice_id">

                <div class="form-row">
                    <div class="form-group">
                        <label for="payment-method" class="form-label">Payment Method *</label>
                        <select id="payment-method" name="method" class="form-input" required>
                            <option value="">Select Method</option>
                            <option value="Cash">Cash</option>
                            <option value="Credit Card">Credit Card</option>
                            <option value="Debit Card">Debit Card</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="UPI">UPI</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="amount-paid" class="form-label">Amount Paid *</label>
                        <input type="number" id="amount-paid" name="amount_paid" class="form-input" step="0.01" min="0" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="payment-date" class="form-label">Payment Date *</label>
                        <input type="date" id="payment-date" name="date" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="transaction-reference" class="form-label">Transaction Reference</label>
                        <input type="text" id="transaction-reference" name="transaction_reference" class="form-input">
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary">Record Payment</button>
                    <button type="button" id="payment-cancel-btn" class="btn btn-secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alert-container" style="position: fixed; top: 20px; right: 20px; z-index: 1000;"></div>

    <!-- Load API utilities -->
    <script src="js/api.js"></script>
    <script>
        let currentPage = 1;
        let currentPaymentFilter = '';
        let serviceRequests = [];

        // DOM elements
        const invoicesTableContainer = document.getElementById('invoices-table-container');
        const paginationContainer = document.getElementById('pagination-container');
        const invoiceModal = document.getElementById('invoice-modal');
        const invoiceForm = document.getElementById('invoice-form');
        const invoiceDetailsModal = document.getElementById('invoice-details-modal');
        const paymentModal = document.getElementById('payment-modal');
        const paymentForm = document.getElementById('payment-form');
        const paymentFilter = document.getElementById('payment-filter');

        // Modal controls
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.onclick = () => {
                invoiceModal.style.display = 'none';
                invoiceDetailsModal.style.display = 'none';
                paymentModal.style.display = 'none';
            };
        });

        document.getElementById('invoice-cancel-btn').onclick = () => invoiceModal.style.display = 'none';
        document.getElementById('payment-cancel-btn').onclick = () => paymentModal.style.display = 'none';

        window.onclick = (event) => {
            if (event.target === invoiceModal) invoiceModal.style.display = 'none';
            if (event.target === invoiceDetailsModal) invoiceDetailsModal.style.display = 'none';
            if (event.target === paymentModal) paymentModal.style.display = 'none';
        };

        // Load invoices
        async function loadInvoices(page = 1, paymentPending = '') {
            try {
                API.utils.showLoading(invoicesTableContainer);

                const response = await API.invoice.getAll(page, 10, paymentPending);
                if (response.success) {
                    displayInvoices(response.data.invoices || response.data);
                    displayPagination(response.data.pagination);
                } else {
                    API.utils.showAlert('Failed to load invoices', 'error');
                }
            } catch (error) {
                console.error('Error loading invoices:', error);
                API.utils.showAlert('Error loading invoices', 'error');
                invoicesTableContainer.innerHTML = '<p>Error loading invoices. Please try again.</p>';
            }
        }

        // Display invoices in table
        function displayInvoices(invoices) {
            if (invoices.length === 0) {
                invoicesTableContainer.innerHTML = '<p>No invoices found.</p>';
                return;
            }

            const tableHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Customer</th>
                            <th>Service Type</th>
                            <th>Total Amount</th>
                            <th>Payment Status</th>
                            <th>Due Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${invoices.map(invoice => `
                            <tr>
                                <td>${invoice.invoice_id}</td>
                                <td>${invoice.customer_name}<br><small>${invoice.customer_phone}</small></td>
                                <td>${invoice.service_type}</td>
                                <td>${API.utils.formatCurrency(invoice.total_amount)}</td>
                                <td>
                                    <span style="padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.875rem; font-weight: 500;
                                        ${invoice.payment_pending ? 'background: #fef3c7; color: #92400e;' : 'background: #d1fae5; color: #065f46;'}">
                                        ${invoice.payment_pending ? 'Pending' : 'Paid'}
                                    </span>
                                </td>
                                <td>${invoice.due_date ? API.utils.formatDate(invoice.due_date) : 'N/A'}</td>
                                <td>
                                    <button onclick="viewInvoice(${invoice.invoice_id})" class="btn btn-secondary btn-sm">View</button>
                                    <button onclick="editInvoice(${invoice.invoice_id})" class="btn btn-warning btn-sm">Edit</button>
                                    <button onclick="deleteInvoice(${invoice.invoice_id})" class="btn btn-danger btn-sm">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            invoicesTableContainer.innerHTML = tableHTML;
        }

        // Display pagination
        function displayPagination(pagination) {
            if (!pagination || pagination.totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }

            let paginationHTML = '';

            if (pagination.page > 1) {
                paginationHTML += `<button class="pagination-btn" onclick="changePage(${pagination.page - 1})">Previous</button>`;
            }

            for (let i = Math.max(1, pagination.page - 2); i <= Math.min(pagination.totalPages, pagination.page + 2); i++) {
                paginationHTML += `<button class="pagination-btn ${i === pagination.page ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            }

            if (pagination.page < pagination.totalPages) {
                paginationHTML += `<button class="pagination-btn" onclick="changePage(${pagination.page + 1})">Next</button>`;
            }

            paginationContainer.innerHTML = paginationHTML;
        }

        // Change page
        function changePage(page) {
            currentPage = page;
            loadInvoices(currentPage, currentPaymentFilter);
        }

        // Filter by payment status
        function filterByPayment() {
            currentPaymentFilter = paymentFilter.value;
            currentPage = 1;
            loadInvoices(currentPage, currentPaymentFilter);
        }

        // Load service requests for dropdown
        async function loadServiceRequests() {
            try {
                const response = await API.service.getAll(1, 1000, 'Completed'); // Only completed services
                if (response.success) {
                    serviceRequests = response.data.serviceRequests || response.data;
                    populateServiceRequestSelect();
                }
            } catch (error) {
                console.error('Error loading service requests:', error);
            }
        }

        // Populate service request select
        function populateServiceRequestSelect() {
            const select = document.getElementById('service-request-select');
            select.innerHTML = '<option value="">Select Service Request</option>';
            serviceRequests.forEach(request => {
                select.innerHTML += `<option value="${request.service_request_id}">${request.service_request_id} - ${request.customer_name} (${request.service_type})</option>`;
            });
        }

        // Add new invoice
        function addInvoice() {
            document.getElementById('invoice-modal-title').textContent = 'Create Invoice';
            invoiceForm.reset();
            document.getElementById('invoice-id').value = '';
            // Set default date to today
            document.getElementById('invoice-date').value = new Date().toISOString().split('T')[0];
            invoiceModal.style.display = 'block';
        }

        // Edit invoice
        async function editInvoice(id) {
            try {
                const response = await API.invoice.getById(id);
                if (response.success) {
                    const invoice = response.data;
                    document.getElementById('invoice-modal-title').textContent = 'Edit Invoice';
                    document.getElementById('invoice-id').value = invoice.invoice_id;
                    document.getElementById('service-request-select').value = invoice.service_request_id;
                    document.getElementById('total-amount').value = invoice.total_amount;
                    document.getElementById('invoice-date').value = invoice.date.split('T')[0];
                    document.getElementById('due-date').value = invoice.due_date ? invoice.due_date.split('T')[0] : '';
                    document.getElementById('payment-pending').value = invoice.payment_pending.toString();
                    invoiceModal.style.display = 'block';
                } else {
                    API.utils.showAlert('Failed to load invoice details', 'error');
                }
            } catch (error) {
                console.error('Error loading invoice:', error);
                API.utils.showAlert('Error loading invoice details', 'error');
            }
        }

        // View invoice details
        async function viewInvoice(id) {
            try {
                const response = await API.invoice.getById(id);
                if (response.success) {
                    const invoice = response.data;
                    const detailsContent = document.getElementById('invoice-details-content');

                    detailsContent.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <div><strong>Invoice ID:</strong> ${invoice.invoice_id}</div>
                            <div><strong>Service Request:</strong> ${invoice.service_request_id}</div>
                            <div><strong>Service Type:</strong> ${invoice.service_type}</div>
                            <div><strong>Service Status:</strong> ${invoice.service_status}</div>
                            <div><strong>Total Amount:</strong> ${API.utils.formatCurrency(invoice.total_amount)}</div>
                            <div><strong>Payment Status:</strong> <span style="padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.875rem; font-weight: 500;
                                ${invoice.payment_pending ? 'background: #fef3c7; color: #92400e;' : 'background: #d1fae5; color: #065f46;'}">${invoice.payment_pending ? 'Pending' : 'Paid'}</span></div>
                            <div><strong>Invoice Date:</strong> ${API.utils.formatDate(invoice.date)}</div>
                            <div><strong>Due Date:</strong> ${invoice.due_date ? API.utils.formatDate(invoice.due_date) : 'N/A'}</div>
                            <div><strong>Customer:</strong> ${invoice.customer_name}</div>
                            <div><strong>Phone:</strong> ${invoice.customer_phone}</div>
                            <div><strong>Email:</strong> ${invoice.customer_email}</div>
                        </div>
                    `;

                    if (invoice.payments && invoice.payments.length > 0) {
                        detailsContent.innerHTML += `
                            <h3>Payment History</h3>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Method</th>
                                        <th>Amount</th>
                                        <th>Reference</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${invoice.payments.map(payment => `
                                        <tr>
                                            <td>${API.utils.formatDate(payment.date)}</td>
                                            <td>${payment.method}</td>
                                            <td>${API.utils.formatCurrency(payment.amount_paid)}</td>
                                            <td>${payment.transaction_reference || 'N/A'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                    } else {
                        detailsContent.innerHTML += '<p>No payments recorded yet.</p>';
                    }

                    document.getElementById('add-payment-btn').onclick = () => addPayment(invoice.invoice_id);
                    document.getElementById('edit-invoice-btn').onclick = () => {
                        invoiceDetailsModal.style.display = 'none';
                        editInvoice(id);
                    };

                    invoiceDetailsModal.style.display = 'block';
                } else {
                    API.utils.showAlert('Failed to load invoice details', 'error');
                }
            } catch (error) {
                console.error('Error loading invoice details:', error);
                API.utils.showAlert('Error loading invoice details', 'error');
            }
        }

        // Add payment
        function addPayment(invoiceId) {
            document.getElementById('payment-invoice-id').value = invoiceId;
            paymentForm.reset();
            document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
            invoiceDetailsModal.style.display = 'none';
            paymentModal.style.display = 'block';
        }

        // Delete invoice
        async function deleteInvoice(id) {
            if (!confirm('Are you sure you want to delete this invoice? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await API.invoice.delete(id);
                if (response.success) {
                    API.utils.showAlert('Invoice deleted successfully', 'success');
                    loadInvoices(currentPage, currentPaymentFilter);
                } else {
                    API.utils.showAlert('Failed to delete invoice', 'error');
                }
            } catch (error) {
                console.error('Error deleting invoice:', error);
                API.utils.showAlert(error.message || 'Error deleting invoice', 'error');
            }
        }

        // Handle invoice form submission
        invoiceForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(invoiceForm);
            const invoiceData = {
                service_request_id: formData.get('service_request_id'),
                total_amount: formData.get('total_amount'),
                date: formData.get('date'),
                due_date: formData.get('due_date'),
                payment_pending: formData.get('payment_pending') === 'true'
            };

            const invoiceId = formData.get('invoice_id');

            try {
                let response;
                if (invoiceId) {
                    response = await API.invoice.update(invoiceId, invoiceData);
                } else {
                    response = await API.invoice.create(invoiceData);
                }

                if (response.success) {
                    API.utils.showAlert(`Invoice ${invoiceId ? 'updated' : 'created'} successfully`, 'success');
                    invoiceModal.style.display = 'none';
                    loadInvoices(currentPage, currentPaymentFilter);
                } else {
                    API.utils.showAlert(`Failed to ${invoiceId ? 'update' : 'create'} invoice`, 'error');
                }
            } catch (error) {
                console.error('Error saving invoice:', error);
                API.utils.showAlert(`Error ${invoiceId ? 'updating' : 'creating'} invoice`, 'error');
            }
        });

        // Handle payment form submission
        paymentForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(paymentForm);
            const paymentData = {
                invoice_id: formData.get('invoice_id'),
                method: formData.get('method'),
                amount_paid: formData.get('amount_paid'),
                date: formData.get('date'),
                transaction_reference: formData.get('transaction_reference')
            };

            try {
                const response = await API.invoice.createPayment(paymentData);
                if (response.success) {
                    API.utils.showAlert('Payment recorded successfully', 'success');
                    paymentModal.style.display = 'none';
                    loadInvoices(currentPage, currentPaymentFilter);
                } else {
                    API.utils.showAlert('Failed to record payment', 'error');
                }
            } catch (error) {
                console.error('Error recording payment:', error);
                API.utils.showAlert('Error recording payment', 'error');
            }
        });

        // Event listeners
        document.getElementById('add-invoice-btn').addEventListener('click', addInvoice);
        paymentFilter.addEventListener('change', filterByPayment);

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadInvoices();
            loadServiceRequests();
            
            // Set active navbar link
            const currentPage = window.location.pathname.split('/').pop() || 'invoices.html';
            const navLinks = document.querySelectorAll('.navbar-menu a');
            navLinks.forEach(link => {
                if (link.getAttribute('href') === currentPage) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
