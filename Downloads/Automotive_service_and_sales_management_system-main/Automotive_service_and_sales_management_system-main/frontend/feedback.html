<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback - Automotive Service & Sales Management System</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="index.html" class="navbar-brand">
                üöó AutoTrade
            </a>
            <ul class="navbar-menu">
                <li><a href="index.html" class="active">Home</a></li>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="customers.html">Customers</a></li>
                <li><a href="vehicles.html">Vehicles</a></li>
                <li><a href="services.html">Services</a></li>
                <li><a href="history.html">History</a></li>
                <li><a href="employees.html">Employees</a></li>
                <li><a href="inventory.html">Inventory</a></li>
                <li><a href="invoices.html">Invoices</a></li>
                <li><a href="feedback.html">Feedback</a></li>
                <li><a href="insurance.html">Insurance</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <div class="page-header">
            <h1>Customer Feedback</h1>
            <p>View and manage customer feedback and ratings</p>
        </div>

        <!-- Actions Bar -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Feedback</h2>
                <div style="display: flex; gap: 1rem;">
                    <button id="add-feedback-btn" class="btn btn-primary">Add Feedback</button>
                    <button id="refresh-feedback-btn" class="btn btn-secondary">Refresh</button>
                </div>
            </div>

            <!-- Feedback List -->
            <div id="feedback-container">
                <!-- Feedback will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Add Feedback Modal -->
    <div id="feedback-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Customer Feedback</h2>
                <span class="close">&times;</span>
            </div>
            <form id="feedback-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="customer-select" class="form-label">Customer *</label>
                        <select id="customer-select" name="customer_id" class="form-input" required>
                            <option value="">Select Customer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="service-request-select" class="form-label">Service Request *</label>
                        <select id="service-request-select" name="service_request_id" class="form-input" required>
                            <option value="">Select Service Request</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="rating" class="form-label">Rating *</label>
                        <select id="rating" name="rating" class="form-input" required>
                            <option value="">Select Rating</option>
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excellent (5)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Very Good (4)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê Good (3)</option>
                            <option value="2">‚≠ê‚≠ê Fair (2)</option>
                            <option value="1">‚≠ê Poor (1)</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="comments" class="form-label">Comments</label>
                    <textarea id="comments" name="comments" class="form-input" rows="4" placeholder="Enter customer feedback comments..."></textarea>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary">Submit Feedback</button>
                    <button type="button" id="feedback-cancel-btn" class="btn btn-secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alert-container" style="position: fixed; top: 20px; right: 20px; z-index: 1000;"></div>

    <!-- Load API utilities -->
    <script src="js/api.js"></script>
    <script>
        let customers = [];
        let serviceRequests = [];

        // DOM elements
        const feedbackContainer = document.getElementById('feedback-container');
        const feedbackModal = document.getElementById('feedback-modal');
        const feedbackForm = document.getElementById('feedback-form');

        // Modal controls
        document.querySelector('.close').onclick = () => feedbackModal.style.display = 'none';
        document.getElementById('feedback-cancel-btn').onclick = () => feedbackModal.style.display = 'none';

        window.onclick = (event) => {
            if (event.target === feedbackModal) feedbackModal.style.display = 'none';
        };

        // Load feedback
        async function loadFeedback() {
            try {
                API.utils.showLoading(feedbackContainer);

                const response = await API.feedback.getAll();
                if (response.success) {
                    displayFeedback(response.data);
                } else {
                    API.utils.showAlert('Failed to load feedback', 'error');
                }
            } catch (error) {
                console.error('Error loading feedback:', error);
                API.utils.showAlert('Error loading feedback', 'error');
                feedbackContainer.innerHTML = '<p>Error loading feedback. Please try again.</p>';
            }
        }

        // Display feedback
        function displayFeedback(feedback) {
            if (feedback.length === 0) {
                feedbackContainer.innerHTML = '<p>No feedback found.</p>';
                return;
            }

            const feedbackHTML = `
                <div style="display: grid; gap: 1.5rem;">
                    ${feedback.map(item => `
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <h3 style="margin: 0; font-size: 1.1rem;">${item.customer_name}</h3>
                                    <small style="color: var(--text-secondary);">${item.customer_phone}</small>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">
                                        ${'‚≠ê'.repeat(item.rating)}${'‚òÜ'.repeat(5 - item.rating)}
                                    </div>
                                    <small style="color: var(--text-secondary);">${API.utils.formatDate(item.created_at)}</small>
                                </div>
                            </div>
                            <div style="padding: 1rem;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                                    <div><strong>Service Type:</strong> ${item.service_type}</div>
                                    <div><strong>Service Status:</strong> ${item.service_status}</div>
                                    <div><strong>Rating:</strong> ${item.rating}/5</div>
                                </div>
                                ${item.comments ? `
                                    <div>
                                        <strong>Comments:</strong>
                                        <p style="margin-top: 0.5rem; padding: 1rem; background: var(--light-bg); border-radius: 0.375rem;">${item.comments}</p>
                                    </div>
                                ` : '<p style="color: var(--text-secondary); font-style: italic;">No comments provided</p>'}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            feedbackContainer.innerHTML = feedbackHTML;
        }

        // Load customers for dropdown
        async function loadCustomers() {
            try {
                const response = await API.customer.getAll(1, 1000);
                if (response.success) {
                    customers = response.data.customers || response.data;
                    populateCustomerSelect();
                }
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }

        // Populate customer select
        function populateCustomerSelect() {
            const select = document.getElementById('customer-select');
            select.innerHTML = '<option value="">Select Customer</option>';
            customers.forEach(customer => {
                select.innerHTML += `<option value="${customer.customer_id}">${customer.name} - ${customer.phone}</option>`;
            });
        }

        // Load service requests for dropdown
        async function loadServiceRequests() {
            try {
                const response = await API.service.getAll(1, 1000, 'Completed'); // Only completed services
                if (response.success) {
                    serviceRequests = response.data.serviceRequests || response.data;
                    populateServiceRequestSelect();
                }
            } catch (error) {
                console.error('Error loading service requests:', error);
            }
        }

        // Populate service request select
        function populateServiceRequestSelect() {
            const select = document.getElementById('service-request-select');
            select.innerHTML = '<option value="">Select Service Request</option>';
            serviceRequests.forEach(request => {
                select.innerHTML += `<option value="${request.service_request_id}">${request.service_request_id} - ${request.customer_name} (${request.service_type})</option>`;
            });
        }

        // Add new feedback
        function addFeedback() {
            feedbackForm.reset();
            feedbackModal.style.display = 'block';
        }

        // Handle feedback form submission
        feedbackForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(feedbackForm);
            const feedbackData = {
                customer_id: formData.get('customer_id'),
                service_request_id: formData.get('service_request_id'),
                rating: formData.get('rating'),
                comments: formData.get('comments')
            };

            try {
                const response = await API.feedback.create(feedbackData);
                if (response.success) {
                    API.utils.showAlert('Feedback submitted successfully', 'success');
                    feedbackModal.style.display = 'none';
                    loadFeedback();
                } else {
                    API.utils.showAlert('Failed to submit feedback', 'error');
                }
            } catch (error) {
                console.error('Error submitting feedback:', error);
                API.utils.showAlert('Error submitting feedback', 'error');
            }
        });

        // Event listeners
        document.getElementById('add-feedback-btn').addEventListener('click', addFeedback);
        document.getElementById('refresh-feedback-btn').addEventListener('click', loadFeedback);

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadFeedback();
            loadCustomers();
            loadServiceRequests();
            
            // Set active navbar link
            const currentPage = window.location.pathname.split('/').pop() || 'feedback.html';
            const navLinks = document.querySelectorAll('.navbar-menu a');
            navLinks.forEach(link => {
                if (link.getAttribute('href') === currentPage) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
