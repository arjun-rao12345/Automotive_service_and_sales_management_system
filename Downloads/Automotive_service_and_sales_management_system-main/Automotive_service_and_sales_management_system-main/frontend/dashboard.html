<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Automotive Service & Sales Management System</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="index.html" class="navbar-brand">
                ðŸš— AutoTrade
            </a>
            <ul class="navbar-menu">
                <li><a href="index.html" class="active">Home</a></li>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="customers.html">Customers</a></li>
                <li><a href="vehicles.html">Vehicles</a></li>
                <li><a href="services.html">Services</a></li>
                <li><a href="history.html">History</a></li>
                <li><a href="employees.html">Employees</a></li>
                <li><a href="inventory.html">Inventory</a></li>
                <li><a href="invoices.html">Invoices</a></li>
                <li><a href="feedback.html">Feedback</a></li>
                <li><a href="insurance.html">Insurance</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <div class="page-header">
            <h1>Dashboard</h1>
            <p>Overview of your automotive service operations</p>
        </div>

        <!-- Statistics Cards -->
        <div id="stats-grid" class="stats-grid">
            <!-- Stats will be loaded here -->
        </div>

        <!-- Charts Section -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Service Status Distribution</h2>
                </div>
                <div id="service-chart" style="height: 300px; display: flex; align-items: center; justify-content: center;">
                    <div class="loading"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Monthly Revenue</h2>
                </div>
                <div id="revenue-chart" style="height: 300px; display: flex; align-items: center; justify-content: center;">
                    <div class="loading"></div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Recent Activity</h2>
            </div>
            <div id="recent-activity">
                <!-- Activity will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alert-container" style="position: fixed; top: 20px; right: 20px; z-index: 1000;"></div>

    <!-- Load API utilities -->
    <script src="js/api.js"></script>
    <script>


        // Load dashboard statistics
        async function loadStats() {
            try {
                // Load general stats (which now includes all needed data)
                const generalResponse = await API.dashboard.getStats();

                if (generalResponse.success) {
                    const generalStats = generalResponse.data;
                    const statsGrid = document.getElementById('stats-grid');

                    statsGrid.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-value">${generalStats.totalServices || 0}</div>
                            <div class="stat-label">Total Services</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${generalStats.pendingServices || 0}</div>
                            <div class="stat-label">Pending Services</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${generalStats.inProgressServices || 0}</div>
                            <div class="stat-label">In Progress</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${generalStats.completedServices || 0}</div>
                            <div class="stat-label">Completed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${generalStats.todayServices || 0}</div>
                            <div class="stat-label">Services Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${generalStats.monthlyServices || 0}</div>
                            <div class="stat-label">This Month</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${generalStats.yearlyServices || 0}</div>
                            <div class="stat-label">This Year</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${generalStats.totalCustomers || 0}</div>
                            <div class="stat-label">Total Customers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${generalStats.totalVehicles || 0}</div>
                            <div class="stat-label">Total Vehicles</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${generalStats.pendingPayments || 0}</div>
                            <div class="stat-label">Pending Payments</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${API.utils.formatCurrency(generalStats.totalRevenue || 0)}</div>
                            <div class="stat-label">Total Revenue</div>
                        </div>
                    `;
                } else {
                    API.utils.showAlert('Failed to load statistics', 'error');
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                API.utils.showAlert('Error loading dashboard statistics', 'error');
            }
        }

        // Load service status chart (simple bar chart)
        async function loadServiceChart() {
            try {
                const response = await API.dashboard.getServiceChart();
                const data = response;

                if (data.success) {
                    const chartContainer = document.getElementById('service-chart');
                    const statusData = data.data;

                    if (statusData.length === 0) {
                        chartContainer.innerHTML = '<p>No service data available</p>';
                        return;
                    }

                    const maxCount = Math.max(...statusData.map(item => item.count));
                    const colors = {
                        'Pending': '#f59e0b',
                        'In Progress': '#2563eb',
                        'Completed': '#10b981',
                        'Cancelled': '#ef4444'
                    };

                    chartContainer.innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 1rem; width: 100%;">
                            ${statusData.map(item => `
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div style="width: 100px; font-size: 0.875rem;">${item.status}</div>
                                    <div style="flex: 1; background: #e5e7eb; height: 20px; border-radius: 10px; overflow: hidden;">
                                        <div style="width: ${(item.count / maxCount) * 100}%; height: 100%; background: ${colors[item.status] || '#6b7280'}; border-radius: 10px;"></div>
                                    </div>
                                    <div style="width: 50px; text-align: right; font-weight: 600;">${item.count}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    document.getElementById('service-chart').innerHTML = '<p>Failed to load chart data</p>';
                }
            } catch (error) {
                console.error('Error loading service chart:', error);
                document.getElementById('service-chart').innerHTML = '<p>Error loading chart</p>';
            }
        }

        // Load revenue chart (simple line chart)
        async function loadRevenueChart() {
            try {
                const response = await API.dashboard.getRevenueChart();
                const data = response;

                if (data.success) {
                    const chartContainer = document.getElementById('revenue-chart');
                    const revenueData = data.data;

                    if (revenueData.length === 0) {
                        chartContainer.innerHTML = '<p>No revenue data available</p>';
                        return;
                    }

                    const maxRevenue = Math.max(...revenueData.map(item => parseFloat(item.revenue)));
                    const months = revenueData.map(item => {
                        const date = new Date(item.month + '-01');
                        return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                    });

                    chartContainer.innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 1rem; width: 100%;">
                            ${revenueData.map((item, index) => `
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div style="width: 60px; font-size: 0.875rem;">${months[index]}</div>
                                    <div style="flex: 1; background: #e5e7eb; height: 20px; border-radius: 10px; overflow: hidden;">
                                        <div style="width: ${(parseFloat(item.revenue) / maxRevenue) * 100}%; height: 100%; background: #10b981; border-radius: 10px;"></div>
                                    </div>
                                    <div style="width: 80px; text-align: right; font-weight: 600; font-size: 0.875rem;">${API.utils.formatCurrency(item.revenue)}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    document.getElementById('revenue-chart').innerHTML = '<p>Failed to load chart data</p>';
                }
            } catch (error) {
                console.error('Error loading revenue chart:', error);
                document.getElementById('revenue-chart').innerHTML = '<p>Error loading chart</p>';
            }
        }

        // Load recent activity
        async function loadRecentActivity() {
            try {
                const response = await API.dashboard.getActivity();
                const data = response;

                if (data.success) {
                    const activity = data.data;
                    const activityContainer = document.getElementById('recent-activity');

                    activityContainer.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem;">
                            <div>
                                <h3>Recent Services</h3>
                                ${activity.recentServices.length > 0 ?
                                    activity.recentServices.map(service => `
                                        <div style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                                            <div style="font-weight: 600;">${service.customer_name}</div>
                                            <div style="color: #6b7280; font-size: 0.875rem;">${service.registration_no} - ${service.service_type}</div>
                                            <div style="color: #6b7280; font-size: 0.875rem;">${API.utils.formatDate(service.requested_date)} - <span style="color: ${service.status === 'Completed' ? '#10b981' : service.status === 'Pending' ? '#f59e0b' : '#2563eb'};">${service.status}</span></div>
                                        </div>
                                    `).join('') :
                                    '<p>No recent services</p>'
                                }
                            </div>
                            <div>
                                <h3>Recent Invoices</h3>
                                ${activity.recentInvoices.length > 0 ?
                                    activity.recentInvoices.map(invoice => `
                                        <div style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                                            <div style="font-weight: 600;">${invoice.customer_name}</div>
                                            <div style="color: #6b7280; font-size: 0.875rem;">${API.utils.formatCurrency(invoice.total_amount)}</div>
                                            <div style="color: #6b7280; font-size: 0.875rem;">${API.utils.formatDate(invoice.date)} - <span style="color: ${invoice.payment_pending ? '#ef4444' : '#10b981'};">${invoice.payment_pending ? 'Pending' : 'Paid'}</span></div>
                                        </div>
                                    `).join('') :
                                    '<p>No recent invoices</p>'
                                }
                            </div>
                        </div>
                    `;
                } else {
                    API.utils.showAlert('Failed to load recent activity', 'error');
                }
            } catch (error) {
                console.error('Error loading recent activity:', error);
                API.utils.showAlert('Error loading recent activity', 'error');
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadServiceChart();
            loadRevenueChart();
            loadRecentActivity();
            
            // Set active navbar link
            const currentPage = window.location.pathname.split('/').pop() || 'dashboard.html';
            const navLinks = document.querySelectorAll('.navbar-menu a');
            navLinks.forEach(link => {
                if (link.getAttribute('href') === currentPage) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
