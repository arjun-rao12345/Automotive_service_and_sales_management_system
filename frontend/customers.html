<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customers - Automotive Service & Sales Management System</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="index.html" class="navbar-brand">
                ðŸš— AutoService Pro
            </a>
            <ul class="navbar-menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="customers.html" class="active">Customers</a></li>
                <li><a href="vehicles.html">Vehicles</a></li>
                <li><a href="services.html">Services</a></li>
                <li><a href="employees.html">Employees</a></li>
                <li><a href="inventory.html">Inventory</a></li>
                <li><a href="invoices.html">Invoices</a></li>
                <li><a href="feedback.html">Feedback</a></li>
                <li><a href="insurance.html">Insurance</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <div class="page-header">
            <h1>Customer Management</h1>
            <p>Manage customer information and profiles</p>
        </div>

        <!-- Search and Actions -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Customers</h2>
                <button id="add-customer-btn" class="btn btn-primary">Add New Customer</button>
            </div>

            <div class="search-container">
                <input type="text" id="search-input" class="search-input" placeholder="Search customers by name, email, or phone...">
                <button id="search-btn" class="btn btn-secondary">Search</button>
            </div>

            <!-- Customers Table -->
            <div id="customers-table-container">
                <!-- Table will be loaded here -->
            </div>

            <!-- Pagination -->
            <div id="pagination-container" class="pagination">
                <!-- Pagination will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Add/Edit Customer Modal -->
    <div id="customer-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title" class="modal-title">Add Customer</h2>
                <span class="close">&times;</span>
            </div>
            <form id="customer-form">
                <input type="hidden" id="customer-id" name="customer_id">

                <div class="form-row">
                    <div class="form-group">
                        <label for="customer-name" class="form-label">Name *</label>
                        <input type="text" id="customer-name" name="name" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="customer-phone" class="form-label">Phone *</label>
                        <input type="tel" id="customer-phone" name="phone" class="form-input" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="customer-email" class="form-label">Email *</label>
                        <input type="email" id="customer-email" name="email" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="customer-address" class="form-label">Address</label>
                        <input type="text" id="customer-address" name="address" class="form-input">
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary">Save Customer</button>
                    <button type="button" id="cancel-btn" class="btn btn-secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alert-container" style="position: fixed; top: 20px; right: 20px; z-index: 1000;"></div>

    <!-- Load API utilities -->
    <script src="js/api.js"></script>
    <script>
        let currentPage = 1;
        let currentSearch = '';
        let isSearching = false;

        // DOM elements
        const customersTableContainer = document.getElementById('customers-table-container');
        const paginationContainer = document.getElementById('pagination-container');
        const customerModal = document.getElementById('customer-modal');
        const customerForm = document.getElementById('customer-form');
        const modalTitle = document.getElementById('modal-title');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const addCustomerBtn = document.getElementById('add-customer-btn');

        // Modal controls
        document.querySelector('.close').onclick = () => customerModal.style.display = 'none';
        document.getElementById('cancel-btn').onclick = () => customerModal.style.display = 'none';

        window.onclick = (event) => {
            if (event.target === customerModal) {
                customerModal.style.display = 'none';
            }
        };

        // Load customers
        async function loadCustomers(page = 1, search = '') {
            try {
                API.utils.showLoading(customersTableContainer);

                let response;
                if (search) {
                    response = await API.customer.search(search);
                } else {
                    response = await API.customer.getAll(page);
                }

                if (response.success) {
                    displayCustomers(response.data.customers || response.data);
                    if (!search) {
                        displayPagination(response.data.pagination);
                    } else {
                        paginationContainer.innerHTML = '';
                    }
                } else {
                    API.utils.showAlert('Failed to load customers', 'error');
                }
            } catch (error) {
                console.error('Error loading customers:', error);
                API.utils.showAlert('Error loading customers', 'error');
                customersTableContainer.innerHTML = '<p>Error loading customers. Please try again.</p>';
            }
        }

        // Display customers in table
        function displayCustomers(customers) {
            if (customers.length === 0) {
                customersTableContainer.innerHTML = '<p>No customers found.</p>';
                return;
            }

            const tableHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Address</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${customers.map(customer => `
                            <tr>
                                <td>${customer.customer_id}</td>
                                <td>${customer.name}</td>
                                <td>${customer.phone}</td>
                                <td>${customer.email}</td>
                                <td>${customer.address || '-'}</td>
                                <td>${API.utils.formatDate(customer.created_at)}</td>
                                <td>
                                    <button onclick="editCustomer(${customer.customer_id})" class="btn btn-secondary btn-sm">Edit</button>
                                    <button onclick="viewCustomer(${customer.customer_id})" class="btn btn-warning btn-sm">View</button>
                                    <button onclick="deleteCustomer(${customer.customer_id})" class="btn btn-danger btn-sm">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            customersTableContainer.innerHTML = tableHTML;
        }

        // Display pagination
        function displayPagination(pagination) {
            if (!pagination || pagination.totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }

            let paginationHTML = '';

            // Previous button
            if (pagination.page > 1) {
                paginationHTML += `<button class="pagination-btn" onclick="changePage(${pagination.page - 1})">Previous</button>`;
            }

            // Page numbers
            for (let i = Math.max(1, pagination.page - 2); i <= Math.min(pagination.totalPages, pagination.page + 2); i++) {
                paginationHTML += `<button class="pagination-btn ${i === pagination.page ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            }

            // Next button
            if (pagination.page < pagination.totalPages) {
                paginationHTML += `<button class="pagination-btn" onclick="changePage(${pagination.page + 1})">Next</button>`;
            }

            paginationContainer.innerHTML = paginationHTML;
        }

        // Change page
        function changePage(page) {
            currentPage = page;
            loadCustomers(currentPage, currentSearch);
        }

        // Search customers
        function performSearch() {
            currentSearch = searchInput.value.trim();
            currentPage = 1;
            isSearching = currentSearch.length > 0;
            loadCustomers(currentPage, currentSearch);
        }

        // Add new customer
        function addCustomer() {
            modalTitle.textContent = 'Add Customer';
            customerForm.reset();
            document.getElementById('customer-id').value = '';
            customerModal.style.display = 'block';
        }

        // Edit customer
        async function editCustomer(id) {
            try {
                const response = await API.customer.getById(id);
                if (response.success) {
                    const customer = response.data;
                    modalTitle.textContent = 'Edit Customer';
                    document.getElementById('customer-id').value = customer.customer_id;
                    document.getElementById('customer-name').value = customer.name;
                    document.getElementById('customer-phone').value = customer.phone;
                    document.getElementById('customer-email').value = customer.email;
                    document.getElementById('customer-address').value = customer.address || '';
                    customerModal.style.display = 'block';
                } else {
                    API.utils.showAlert('Failed to load customer details', 'error');
                }
            } catch (error) {
                console.error('Error loading customer:', error);
                API.utils.showAlert('Error loading customer details', 'error');
            }
        }

        // View customer details
        async function viewCustomer(id) {
            try {
                const response = await API.customer.getById(id);
                if (response.success) {
                    const customer = response.data;
                    let detailsHTML = `
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 class="modal-title">Customer Details</h2>
                                <span class="close" onclick="this.closest('.modal').style.display='none'">&times;</span>
                            </div>
                            <div style="padding: 1.5rem;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                                    <div><strong>ID:</strong> ${customer.customer_id}</div>
                                    <div><strong>Name:</strong> ${customer.name}</div>
                                    <div><strong>Phone:</strong> ${customer.phone}</div>
                                    <div><strong>Email:</strong> ${customer.email}</div>
                                    <div><strong>Address:</strong> ${customer.address || 'N/A'}</div>
                                    <div><strong>Created:</strong> ${API.utils.formatDate(customer.created_at)}</div>
                                    <div><strong>Updated:</strong> ${API.utils.formatDate(customer.updated_at)}</div>
                                </div>
                    `;

                    if (customer.vehicles && customer.vehicles.length > 0) {
                        detailsHTML += `
                            <h3>Vehicles (${customer.vehicles.length})</h3>
                            <div style="margin-top: 1rem;">
                                ${customer.vehicles.map(vehicle => `
                                    <div style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                                        <div><strong>${vehicle.brand} ${vehicle.model_name} (${vehicle.year})</strong></div>
                                        <div>Registration: ${vehicle.registration_no}</div>
                                        <div>VIN: ${vehicle.vin_no}</div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else {
                        detailsHTML += '<p>No vehicles registered for this customer.</p>';
                    }

                    detailsHTML += `
                            </div>
                        </div>
                    `;

                    const detailsModal = document.createElement('div');
                    detailsModal.className = 'modal';
                    detailsModal.innerHTML = detailsHTML;
                    document.body.appendChild(detailsModal);
                    detailsModal.style.display = 'block';
                } else {
                    API.utils.showAlert('Failed to load customer details', 'error');
                }
            } catch (error) {
                console.error('Error loading customer details:', error);
                API.utils.showAlert('Error loading customer details', 'error');
            }
        }

        // Delete customer
        async function deleteCustomer(id) {
            if (!confirm('Are you sure you want to delete this customer? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await API.customer.delete(id);
                if (response.success) {
                    API.utils.showAlert('Customer deleted successfully', 'success');
                    loadCustomers(currentPage, currentSearch);
                } else {
                    API.utils.showAlert('Failed to delete customer', 'error');
                }
            } catch (error) {
                console.error('Error deleting customer:', error);
                API.utils.showAlert('Error deleting customer', 'error');
            }
        }

        // Handle form submission
        customerForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(customerForm);
            const customerData = {
                name: formData.get('name'),
                phone: formData.get('phone'),
                email: formData.get('email'),
                address: formData.get('address')
            };

            const customerId = formData.get('customer_id');

            try {
                let response;
                if (customerId) {
                    response = await API.customer.update(customerId, customerData);
                } else {
                    response = await API.customer.create(customerData);
                }

                if (response.success) {
                    API.utils.showAlert(`Customer ${customerId ? 'updated' : 'created'} successfully`, 'success');
                    customerModal.style.display = 'none';
                    loadCustomers(currentPage, currentSearch);
                } else {
                    API.utils.showAlert(`Failed to ${customerId ? 'update' : 'create'} customer`, 'error');
                }
            } catch (error) {
                console.error('Error saving customer:', error);
                API.utils.showAlert(`Error ${customerId ? 'updating' : 'creating'} customer`, 'error');
            }
        });

        // Event listeners
        searchBtn.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
        addCustomerBtn.addEventListener('click', addCustomer);

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadCustomers();
        });
    </script>
</body>
</html>
